<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>UndanganWeb - Katalog Digital</title>
    
    <!-- 1. TAILWIND CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. FIREBASE COMPAT (Versi Global - Lebih Stabil untuk kasus ini) -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: #f1f5f9; -webkit-tap-highlight-color: transparent; }
        .hide-scroll::-webkit-scrollbar { display: none; }
        .hide-scroll { -ms-overflow-style: none; scrollbar-width: none; }
        .active-tab { background-color: #0f172a; color: white; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        .inactive-tab { background-color: white; color: #475569; border: 1px solid #e2e8f0; }
    </style>
</head>

<body class="text-slate-800 pb-24">

    <!-- HEADER -->
    <div class="fixed top-0 w-full bg-white/95 backdrop-blur z-40 shadow-sm border-b border-slate-200">
        <div class="px-4 py-3 flex justify-between items-center max-w-md mx-auto">
            <div>
                <h1 class="font-bold text-lg text-slate-900 tracking-tight">UndanganWeb</h1>
                <p id="status-text" class="text-[10px] font-medium text-orange-500">Menghubungkan...</p>
            </div>
            <div class="bg-slate-50 p-2 rounded-full border border-slate-100">
               <svg class="w-5 h-5 text-slate-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z"></path></svg>
            </div>
        </div>

        <!-- Search Bar -->
        <div class="px-4 pb-2 max-w-md mx-auto">
            <input type="text" id="search-input" placeholder="Cari tema (Jawa, Floral...)" onkeyup="filterProducts()"
                class="w-full bg-slate-100 text-sm py-2.5 px-4 rounded-xl focus:outline-none focus:bg-white focus:ring-2 focus:ring-blue-500 transition-all border-transparent border focus:border-blue-100">
        </div>

        <!-- Kategori Tabs -->
        <div class="flex overflow-x-auto gap-2 px-4 pb-3 hide-scroll max-w-md mx-auto mt-1" id="category-container">
            <!-- Tabs di-render via JS -->
            <button onclick="setCategory('Semua')" class="cat-btn active-tab px-4 py-1.5 rounded-full text-xs font-semibold whitespace-nowrap transition-all active:scale-95">Semua</button>
            <button onclick="setCategory('Wedding')" class="cat-btn inactive-tab px-4 py-1.5 rounded-full text-xs font-semibold whitespace-nowrap transition-all active:scale-95">Wedding</button>
            <button onclick="setCategory('Khitan')" class="cat-btn inactive-tab px-4 py-1.5 rounded-full text-xs font-semibold whitespace-nowrap transition-all active:scale-95">Khitan</button>
            <button onclick="setCategory('Formal')" class="cat-btn inactive-tab px-4 py-1.5 rounded-full text-xs font-semibold whitespace-nowrap transition-all active:scale-95">Formal</button>
        </div>
    </div>

    <div class="h-44 w-full"></div>

    <!-- LOADING STATE -->
    <div id="loading-skeleton" class="px-4 grid grid-cols-2 gap-3 max-w-md mx-auto">
        <div class="bg-white p-2 rounded-xl h-48 animate-pulse bg-slate-200"></div>
        <div class="bg-white p-2 rounded-xl h-48 animate-pulse bg-slate-200"></div>
        <div class="bg-white p-2 rounded-xl h-48 animate-pulse bg-slate-200"></div>
        <div class="bg-white p-2 rounded-xl h-48 animate-pulse bg-slate-200"></div>
    </div>

    <!-- ERROR AREA -->
    <div id="error-area" class="hidden px-4 text-center mt-10">
        <div class="bg-red-50 p-4 rounded-xl border border-red-200 text-red-600 text-sm">
            <p class="font-bold">Gagal Memuat Data</p>
            <p id="error-msg" class="text-xs mt-1"></p>
        </div>
    </div>

    <!-- GRID PRODUK UTAMA (Container Kosong untuk diisi JS) -->
    <div id="product-grid" class="px-3 grid grid-cols-2 gap-3 max-w-md mx-auto pb-10">
        <!-- Produk akan muncul disini -->
    </div>

    <!-- MODAL DETAIL -->
    <div id="detail-modal" class="fixed inset-0 bg-white z-50 overflow-y-auto hidden flex-col transition-transform duration-300 translate-y-full">
        
        <!-- Tombol Close & Nav -->
        <div class="absolute top-0 w-full p-4 flex justify-between items-center z-10 pointer-events-none">
            <button onclick="closeModal()" class="bg-black/30 backdrop-blur text-white p-2 rounded-full pointer-events-auto hover:bg-black/50">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
            </button>
        </div>

        <!-- Gambar -->
        <div class="h-[60vh] bg-slate-200 relative shrink-0">
             <img id="modal-img" src="" class="w-full h-full object-cover">
        </div>
        
        <!-- Konten -->
        <div class="flex-1 p-6 -mt-8 bg-white rounded-t-[2rem] relative shadow-[0_-5px_20px_rgba(0,0,0,0.1)] z-0">
            <div class="w-12 h-1 bg-slate-200 rounded-full mx-auto mb-6"></div>
            
            <span id="modal-category" class="text-[10px] font-bold text-blue-600 bg-blue-50 px-2.5 py-1 rounded-full border border-blue-100 uppercase tracking-wider"></span>
            <h1 id="modal-title" class="text-2xl font-bold text-slate-900 mt-2 leading-tight"></h1>

            <div class="flex items-end gap-2 mt-2 pb-6 border-b border-slate-100">
                <p id="modal-price-real" class="text-2xl font-bold text-green-600"></p>
                <p id="modal-price-fake" class="text-sm text-slate-400 line-through mb-1"></p>
            </div>
            
            <div class="mt-6">
                <p class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-2">Deskripsi</p>
                <p id="modal-desc" class="text-sm text-slate-600 leading-relaxed whitespace-pre-line font-medium"></p>
            </div>
            
            <div class="h-24"></div>
        </div>

        <!-- Footer Modal -->
        <div class="fixed bottom-0 w-full bg-white border-t border-slate-100 p-4 flex gap-3 z-50">
            <a id="modal-link" href="#" target="_blank" class="flex-1 bg-slate-50 text-slate-700 font-bold py-3.5 rounded-xl text-center text-sm border border-slate-200 flex items-center justify-center gap-2">Preview</a>
            <button class="flex-[2] bg-slate-900 text-white font-bold py-3.5 rounded-xl shadow-lg shadow-slate-300 text-sm">Pesan Sekarang</button>
        </div>
    </div>

    <!-- SCRIPT UTAMA (VANILLA JS + FIREBASE COMPAT) -->
    <script>
        // 1. KONFIGURASI FIREBASE
        const firebaseConfig = {
            apiKey: "AIzaSyDq6LjlUFRDm5CqGSqVLiJ9gItIyw71bAU",
            authDomain: "db-katalog.firebaseapp.com",
            projectId: "db-katalog",
            storageBucket: "db-katalog.firebasestorage.app",
            messagingSenderId: "597535674259",
            appId: "1:597535674259:web:0577885c617f623bb82266"
        };

        // Inisialisasi Global
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // Variabel Global
        let allProducts = [];
        let currentCategory = 'Semua';

        // 2. FUNGSI FETCH DATA (JANTUNG APLIKASI)
        async function loadData() {
            const statusText = document.getElementById('status-text');
            const loading = document.getElementById('loading-skeleton');
            const errorArea = document.getElementById('error-area');
            const grid = document.getElementById('product-grid');

            console.log("üöÄ Memulai pengambilan data...");

            try {
                // Ambil semua dokumen dari collection 'themes'
                const snapshot = await db.collection('themes').get();
                
                if (snapshot.empty) {
                    statusText.innerText = "Data Kosong";
                    loading.style.display = 'none';
                    errorArea.style.display = 'block';
                    document.getElementById('error-msg').innerText = "Database terhubung tapi tidak ada isinya.";
                    return;
                }

                // Proses Data (Cleaning)
                allProducts = snapshot.docs.map(doc => {
                    let data = doc.data();
                    return {
                        id: doc.id,
                        // AUTO FIX LOGIC: Deteksi kolom yg salah nama
                        title: data.title || data['title '] || 'Tanpa Judul',
                        category: data.category || 'Umum',
                        price_real: data.price_real || data['price-real'] || 0,
                        price_fake: data.price_fake || data['price-fake'] || 0,
                        description: data.description || '',
                        folder_id: data.folder_id || doc.id,
                        tier: data.tier || 'Standard',
                        link: data.link || '#'
                    };
                });

                console.log(`‚úÖ ${allProducts.length} data berhasil dimuat!`);
                
                // Update UI
                statusText.innerText = `Online ‚Ä¢ ${allProducts.length} Tema`;
                statusText.className = "text-[10px] font-medium text-green-600";
                loading.style.display = 'none';
                
                // Render Awal
                renderProducts(allProducts);

            } catch (error) {
                console.error("‚ùå Error:", error);
                statusText.innerText = "Error Koneksi";
                loading.style.display = 'none';
                errorArea.style.display = 'block';
                document.getElementById('error-msg').innerText = error.message;
            }
        }

        // 3. FUNGSI RENDER (MENAMPILKAN KE LAYAR)
        function renderProducts(items) {
            const grid = document.getElementById('product-grid');
            grid.innerHTML = ''; // Bersihkan grid

            if (items.length === 0) {
                grid.innerHTML = '<div class="col-span-2 text-center text-slate-400 py-10 text-sm">Tidak ada tema ditemukan</div>';
                return;
            }

            items.forEach(item => {
                // Hitung Diskon
                let discount = 0;
                if(item.price_fake > item.price_real) {
                    discount = Math.round(((item.price_fake - item.price_real) / item.price_fake) * 100);
                }

                // Format Harga
                const priceDisplay = 'Rp' + Math.floor(item.price_real / 1000) + 'k';
                const fakeDisplay = 'Rp' + Math.floor(item.price_fake / 1000) + 'k';

                // URL Gambar (Placeholder dulu)
                const imgUrl = `https://placehold.co/400x600/f8fafc/64748b?text=${encodeURIComponent(item.title)}`;

                // Buat Elemen HTML
                const card = document.createElement('div');
                card.className = "bg-white p-2.5 rounded-xl shadow-[0_2px_10px_rgba(0,0,0,0.03)] border border-slate-100 active:scale-95 transition-transform cursor-pointer hover:border-blue-200 relative group";
                card.onclick = () => openModal(item); // Event Click

                card.innerHTML = `
                    <div class="relative overflow-hidden rounded-lg bg-slate-100 aspect-[3/4] mb-2">
                        <img src="${imgUrl}" class="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110" loading="lazy">
                        ${discount > 0 ? `<div class="absolute top-1.5 left-1.5 bg-red-500 text-white text-[10px] font-bold px-1.5 py-0.5 rounded shadow-sm">-${discount}%</div>` : ''}
                    </div>
                    <h3 class="text-xs font-bold text-slate-800 truncate leading-tight">${item.title}</h3>
                    <div class="flex items-end gap-1.5 mt-1.5">
                        <p class="text-sm font-bold text-blue-600">${priceDisplay}</p>
                        <p class="text-[10px] text-slate-400 line-through mb-0.5">${fakeDisplay}</p>
                    </div>
                    <div class="mt-2 flex gap-1">
                        <span class="text-[9px] px-1.5 py-0.5 bg-slate-50 text-slate-500 rounded border border-slate-100 uppercase tracking-wide">${item.tier}</span>
                    </div>
                `;
                grid.appendChild(card);
            });
        }

        // 4. FUNGSI FILTER & SEARCH
        function filterProducts() {
            const query = document.getElementById('search-input').value.toLowerCase();
            
            const filtered = allProducts.filter(item => {
                // Filter Kategori
                const catMatch = currentCategory === 'Semua' ? true : 
                                item.category.toLowerCase().includes(currentCategory.toLowerCase());
                
                // Filter Search
                const searchMatch = item.title.toLowerCase().includes(query);
                
                return catMatch && searchMatch;
            });

            renderProducts(filtered);
        }

        function setCategory(cat) {
            currentCategory = cat;
            
            // Update Tampilan Tombol Tab
            const buttons = document.querySelectorAll('.cat-btn');
            buttons.forEach(btn => {
                if(btn.innerText === cat) {
                    btn.classList.remove('inactive-tab');
                    btn.classList.add('active-tab');
                } else {
                    btn.classList.add('inactive-tab');
                    btn.classList.remove('active-tab');
                }
            });

            filterProducts(); // Re-render
        }

        // 5. MODAL LOGIC (Tanpa Alpine)
        function openModal(item) {
            const modal = document.getElementById('detail-modal');
            
            // Isi Data Modal
            document.getElementById('modal-img').src = `https://placehold.co/400x600/f8fafc/64748b?text=${encodeURIComponent(item.title)}`;
            document.getElementById('modal-title').innerText = item.title;
            document.getElementById('modal-category').innerText = item.category;
            document.getElementById('modal-price-real').innerText = 'Rp ' + item.price_real.toLocaleString('id-ID');
            document.getElementById('modal-price-fake').innerText = 'Rp ' + item.price_fake.toLocaleString('id-ID');
            document.getElementById('modal-desc').innerText = item.description;
            document.getElementById('modal-link').href = item.link;

            // Tampilkan Modal (Animasi Slide Up)
            modal.classList.remove('hidden');
            // Sedikit delay biar transisi CSS jalan
            setTimeout(() => {
                modal.classList.remove('translate-y-full');
            }, 10);
            
            document.body.style.overflow = 'hidden'; // Matikan scroll body
        }

        function closeModal() {
            const modal = document.getElementById('detail-modal');
            modal.classList.add('translate-y-full');
            
            setTimeout(() => {
                modal.classList.add('hidden');
            }, 300); // Tunggu durasi transisi CSS
            
            document.body.style.overflow = 'auto';
        }

        // JALANKAN SAAT LOAD
        window.onload = loadData;

    </script>
</body>
</html>
