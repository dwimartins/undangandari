<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Katalog Undangan Digital</title>
    
    <!-- 1. TAILWIND CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. FIREBASE COMPAT -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        wa: {
                            bg: '#111b21',       /* Background Utama Gelap */
                            header: '#202c33',   /* Header/Card */
                            teal: '#00a884',     /* Hijau WA */
                            light: '#e9edef',    /* Teks Utama */
                            gray: '#8696a0',     /* Teks Secondary */
                            divider: '#222d36'   /* Garis Pembatas */
                        }
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    
    <style>
        body { background-color: #111b21; color: #e9edef; -webkit-tap-highlight-color: transparent; }
        .hide-scroll::-webkit-scrollbar { display: none; }
        .hide-scroll { -ms-overflow-style: none; scrollbar-width: none; }
        .snap-x { scroll-snap-type: x mandatory; }
        .snap-center { scroll-snap-align: center; }
        
        /* Transisi Halaman ala App */
        .view-section { display: none; animation: fadeIn 0.3s ease-in-out; }
        .view-active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>

<body class="antialiased min-h-screen pb-20">

    <!-- =======================
         VIEW 1: HOME (TIER LIST)
    ======================== -->
    <div id="view-home" class="view-section view-active">
        <!-- Header Home -->
        <div class="sticky top-0 z-40 bg-wa-header shadow-md border-b border-wa-divider">
            <div class="px-4 h-14 flex justify-between items-center max-w-md mx-auto">
                <h1 class="font-medium text-lg text-wa-light tracking-wide">Katalog Undangan</h1>
                <div class="flex gap-4">
                    <svg class="w-5 h-5 text-wa-gray" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                    <svg class="w-5 h-5 text-wa-gray" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 5v.01M12 12v.01M12 19v.01M12 6a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2z"></path></svg>
                </div>
            </div>
            
            <!-- Filter Chips (Optional jika mau filter cepat) -->
            <div class="px-4 pb-3 flex gap-2 overflow-x-auto hide-scroll max-w-md mx-auto">
                <button class="bg-[#374248] text-wa-teal px-4 py-1.5 rounded-full text-xs font-medium border border-wa-divider">Semua</button>
                <button class="bg-transparent text-wa-gray px-4 py-1.5 rounded-full text-xs font-medium border border-wa-divider">Wedding</button>
                <button class="bg-transparent text-wa-gray px-4 py-1.5 rounded-full text-xs font-medium border border-wa-divider">Khitan</button>
            </div>
        </div>

        <!-- Loading Skeleton -->
        <div id="home-loading" class="max-w-md mx-auto p-4 space-y-6">
            <div class="h-6 w-32 bg-wa-header rounded animate-pulse"></div>
            <div class="grid grid-cols-3 gap-2">
                <div class="aspect-[4/5] bg-wa-header rounded animate-pulse"></div>
                <div class="aspect-[4/5] bg-wa-header rounded animate-pulse"></div>
                <div class="aspect-[4/5] bg-wa-header rounded animate-pulse"></div>
            </div>
        </div>

        <!-- Container List Tier -->
        <div id="tier-list-container" class="max-w-md mx-auto pb-10 space-y-2 mt-2">
            <!-- Disini akan di-inject Section per Tier (Starter, Bronze, dll) -->
        </div>
    </div>


    <!-- =======================
         VIEW 2: CATEGORY FULL
    ======================== -->
    <div id="view-category" class="view-section">
        <!-- Header Category -->
        <div class="sticky top-0 z-40 bg-wa-header shadow-md border-b border-wa-divider">
            <div class="px-2 h-14 flex items-center gap-2 max-w-md mx-auto">
                <button onclick="goHome()" class="p-2 rounded-full hover:bg-[#374248]">
                    <svg class="w-6 h-6 text-wa-light" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg>
                </button>
                <h1 id="cat-header-title" class="font-medium text-lg text-wa-light">Nama Kategori</h1>
            </div>
        </div>

        <div id="cat-grid-container" class="max-w-md mx-auto p-3 grid grid-cols-2 gap-3">
            <!-- Grid produk full disini -->
        </div>
    </div>


    <!-- =======================
         VIEW 3: DETAIL PRODUCT
    ======================== -->
    <div id="view-detail" class="view-section bg-wa-bg min-h-screen">
        <!-- Header Detail (Transparan/Overlay) -->
        <div class="fixed top-0 w-full z-50 max-w-md mx-auto left-0 right-0">
            <div class="flex justify-between items-center p-4 bg-gradient-to-b from-black/60 to-transparent">
                <button onclick="goBack()" class="bg-black/30 backdrop-blur p-2 rounded-full text-white hover:bg-black/50">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
                </button>
                <div class="flex gap-3">
                    <button class="bg-black/30 backdrop-blur p-2 rounded-full text-white hover:bg-black/50">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z"></path></svg>
                    </button>
                </div>
            </div>
        </div>

        <!-- 1:1 Image Slider Container with Peeking Logic -->
        <div class="max-w-md mx-auto relative bg-black">
            <!-- Aspect Ratio 1:1 (Square) -->
            <div class="w-full aspect-square relative overflow-hidden">
                <div id="detail-slider" class="flex overflow-x-auto snap-x snap-mandatory hide-scroll h-full items-center px-4 gap-3">
                    <!-- Images Injected Here -->
                    <!-- Logic: Image width < 100% to allow peeking -->
                </div>
            </div>
            
            <!-- Indicator Dots -->
            <div class="absolute bottom-4 left-0 right-0 flex justify-center gap-1.5 z-10">
                <div class="w-1.5 h-1.5 rounded-full bg-white"></div>
                <div class="w-1.5 h-1.5 rounded-full bg-white/40"></div>
                <div class="w-1.5 h-1.5 rounded-full bg-white/40"></div>
            </div>
        </div>

        <!-- Content Body -->
        <div class="max-w-md mx-auto bg-wa-bg p-5 pb-24">
            <!-- Title & Price -->
            <div class="border-b border-wa-divider pb-4 mb-4">
                <div class="flex justify-between items-start">
                    <h1 id="detail-title" class="text-xl font-medium text-wa-light leading-snug"></h1>
                    <span id="detail-category" class="text-[10px] text-wa-teal border border-wa-teal/30 px-2 py-0.5 rounded uppercase tracking-wide ml-2 shrink-0">Wedding</span>
                </div>
                <div class="mt-2 flex items-center gap-3">
                    <span id="detail-price-real" class="text-lg font-bold text-wa-light"></span>
                    <span id="detail-price-fake" class="text-sm text-wa-gray line-through"></span>
                </div>
            </div>

            <!-- Description -->
            <div class="space-y-3">
                <h3 class="text-sm font-medium text-wa-gray uppercase tracking-wide">Deskripsi Item</h3>
                <p id="detail-desc" class="text-sm text-wa-light leading-relaxed whitespace-pre-line"></p>
            </div>

            <!-- Variants Chips -->
            <div class="mt-6 pt-4 border-t border-wa-divider">
                <h3 class="text-sm font-medium text-wa-gray uppercase tracking-wide mb-3">Fitur Paket</h3>
                <div id="detail-variants" class="flex flex-wrap gap-2">
                    <!-- Chips inserted here -->
                </div>
            </div>
        </div>

        <!-- Sticky Footer Action -->
        <div class="fixed bottom-0 w-full bg-wa-header border-t border-wa-divider p-3 z-50">
            <div class="max-w-md mx-auto flex gap-3">
                <a id="detail-link-preview" href="#" target="_blank" class="flex-1 border border-wa-divider text-wa-teal font-medium py-3 rounded-full text-center text-sm hover:bg-[#2a373f] transition">
                    Lihat Demo
                </a>
                <button onclick="kirimPesanWA()" class="flex-[2] bg-wa-teal text-white font-medium py-3 rounded-full shadow-lg text-sm flex justify-center items-center gap-2 hover:bg-[#008f6f] transition">
                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24"><path d="M.057 24l1.687-6.163c-1.041-1.804-1.588-3.849-1.587-5.946.003-6.556 5.338-11.891 11.893-11.891 3.181.001 6.167 1.24 8.413 3.488 2.245 2.248 3.481 5.236 3.48 8.414-.003 6.557-5.338 11.892-11.893 11.892-1.99-.001-3.951-.5-5.688-1.448l-6.305 1.654zm6.597-3.807c1.676.995 3.276 1.591 5.392 1.592 5.448 0 9.886-4.434 9.889-9.885.002-5.462-4.415-9.89-9.881-9.892-5.452 0-9.887 4.434-9.889 9.884-.001 2.225.651 3.891 1.746 5.634l-.999 3.648 3.742-.981zm11.387-5.464c-.074-.124-.272-.198-.57-.347-.297-.149-1.758-.868-2.031-.967-.272-.099-.47-.149-.669.149-.198.297-.768.967-.941 1.165-.173.198-.347.223-.644.074-.297-.149-1.255-.462-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.297-.347.446-.521.151-.172.2-.296.3-.495.099-.198.05-.372-.025-.521-.075-.148-.669-1.611-.916-2.206-.242-.579-.487-.501-.669-.51l-.57-.01c-.198 0-.52.074-.792.372-.272.297-1.04 1.017-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.095 3.2 5.076 4.487.709.306 1.263.489 1.694.626.712.226 1.36.194 1.872.118.571-.085 1.758-.719 2.006-1.413.248-.695.248-1.29.173-1.414z"/></svg>
                    Order via WA
                </button>
            </div>
        </div>
    </div>


    <!-- SCRIPT LOGIC -->
    <script>
        // CONFIG FIREBASE
        const firebaseConfig = {
            apiKey: "AIzaSyDq6LjlUFRDm5CqGSqVLiJ9gItIyw71bAU",
            authDomain: "db-katalog.firebaseapp.com",
            projectId: "db-katalog",
            storageBucket: "db-katalog.firebasestorage.app",
            messagingSenderId: "597535674259",
            appId: "1:597535674259:web:0577885c617f623bb82266"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // VAR GLOBAL
        let allProducts = [];
        let groupedProducts = {};
        const IMAGEKIT_BASE = "https://ik.imagekit.io/undangandigital";
        // Definisi urutan Tier
        const TIER_ORDER = ["Starter", "Bronze", "Silver", "Gold", "Platinum", "Diamond"];

        // FUNGSI NAVIGASI HALAMAN (ROUTER SEDERHANA)
        let navigationStack = ['view-home'];

        function showView(viewId) {
            // Sembunyikan semua view
            document.querySelectorAll('.view-section').forEach(el => {
                el.classList.remove('view-active');
            });
            // Tampilkan view target
            document.getElementById(viewId).classList.add('view-active');
            window.scrollTo(0,0);
        }

        function goHome() {
            navigationStack = ['view-home'];
            showView('view-home');
        }

        function goBack() {
            if (navigationStack.length > 1) {
                navigationStack.pop(); // Buang view sekarang
                const prevView = navigationStack[navigationStack.length - 1];
                
                // Khusus jika balik ke kategori, kita perlu tau kategori apa
                // Tapi untuk simpelnya, sistem stack ini mengandalkan ID view
                // Jika user dari Detail -> Kategori, view ID nya 'view-category'
                // Karena konten view-category masih static (terakhir dirender), aman.
                showView(prevView);
            } else {
                goHome();
            }
        }

        // LOAD DATA
        async function loadData() {
            try {
                const snapshot = await db.collection('themes').get();
                
                if (snapshot.empty) {
                    alert("Data kosong!"); return;
                }

                allProducts = snapshot.docs.map(doc => {
                    let d = doc.data();
                    return {
                        id: doc.id,
                        title: d.title || d['title '] || 'Tanpa Judul',
                        category: d.category || 'Umum',
                        price_real: d.price_real || d['price-real'] || 0,
                        price_fake: d.price_fake || d['price-fake'] || 0,
                        description: d.description || '',
                        folder_id: d.folder_id || doc.id,
                        tier: d.tier || 'Starter',
                        variants: d.variants || [],
                        link: d.link || '#'
                    };
                });

                // Group by Tier
                groupedProducts = {};
                allProducts.forEach(p => {
                    const tier = p.tier;
                    if(!groupedProducts[tier]) groupedProducts[tier] = [];
                    groupedProducts[tier].push(p);
                });

                document.getElementById('home-loading').style.display = 'none';
                renderHome();

            } catch (error) {
                console.error("Error:", error);
                alert("Gagal memuat data: " + error.message);
            }
        }

        // RENDER HALAMAN UTAMA (TIER LIST)
        function renderHome() {
            const container = document.getElementById('tier-list-container');
            container.innerHTML = '';

            // Loop sesuai urutan tier yg diinginkan
            TIER_ORDER.forEach(tier => {
                const products = groupedProducts[tier];
                if (!products || products.length === 0) return;

                // Ambil 3 produk saja untuk preview
                const previewProducts = products.slice(0, 3);

                // Buat Section HTML
                const section = document.createElement('div');
                section.className = "bg-wa-header mb-2 py-4 shadow-sm"; // Card style container per tier
                
                let cardsHtml = '';
                previewProducts.forEach(item => {
                    const imgUrl = `${IMAGEKIT_BASE}/${item.folder_id}/01.png?tr=w-300`;
                    const price = 'Rp' + Math.floor(item.price_real / 1000) + 'k';
                    
                    cardsHtml += `
                        <div onclick='openDetail(${JSON.stringify(item).replace(/'/g, "&#39;")})' class="cursor-pointer active:opacity-75 transition">
                            <div class="aspect-square rounded-lg overflow-hidden bg-wa-bg mb-2 border border-wa-divider/30">
                                <img src="${imgUrl}" class="w-full h-full object-cover" loading="lazy" onerror="this.src='https://placehold.co/300?text=No+Img'">
                            </div>
                            <h4 class="text-xs text-wa-light font-medium truncate">${item.title}</h4>
                            <span class="text-xs text-wa-teal font-bold">${price}</span>
                        </div>
                    `;
                });

                section.innerHTML = `
                    <div class="px-4 flex justify-between items-center mb-3">
                        <h2 class="text-wa-light font-medium text-sm">Paket ${tier}</h2>
                        <button onclick="openCategory('${tier}')" class="text-wa-gray text-xs font-medium hover:text-wa-teal">Lihat Semua ></button>
                    </div>
                    <div class="px-4 grid grid-cols-3 gap-3">
                        ${cardsHtml}
                    </div>
                `;

                container.appendChild(section);
            });
        }

        // RENDER HALAMAN KATEGORI FULL (VIEW 3)
        function openCategory(tierName) {
            const products = groupedProducts[tierName];
            if(!products) return;

            document.getElementById('cat-header-title').innerText = `Paket ${tierName}`;
            
            const container = document.getElementById('cat-grid-container');
            container.innerHTML = '';

            products.forEach(item => {
                const imgUrl = `${IMAGEKIT_BASE}/${item.folder_id}/01.png?tr=w-400`;
                const price = 'Rp' + Math.floor(item.price_real / 1000) + 'k';

                const card = document.createElement('div');
                card.className = "bg-wa-header p-2 rounded-lg border border-wa-divider active:scale-[0.98] transition cursor-pointer";
                card.onclick = () => openDetail(item);
                
                card.innerHTML = `
                    <div class="aspect-square rounded overflow-hidden bg-wa-bg mb-2">
                        <img src="${imgUrl}" class="w-full h-full object-cover" loading="lazy">
                    </div>
                    <h3 class="text-sm font-medium text-wa-light truncate">${item.title}</h3>
                    <p class="text-sm font-bold text-wa-teal mt-1">${price}</p>
                `;
                container.appendChild(card);
            });

            // Navigasi
            showView('view-category');
            navigationStack.push('view-category');
        }

        // RENDER HALAMAN DETAIL (VIEW 4)
        function openDetail(item) {
            // Set Text
            document.getElementById('detail-title').innerText = item.title;
            document.getElementById('detail-price-real').innerText = 'Rp ' + item.price_real.toLocaleString('id-ID');
            document.getElementById('detail-price-fake').innerText = 'Rp ' + item.price_fake.toLocaleString('id-ID');
            document.getElementById('detail-desc').innerText = item.description;
            document.getElementById('detail-link-preview').href = item.link;

            // Set Variants
            const variantContainer = document.getElementById('detail-variants');
            variantContainer.innerHTML = '';
            if(item.variants && item.variants.length > 0) {
                item.variants.forEach(v => {
                    variantContainer.innerHTML += `<span class="text-xs bg-wa-bg border border-wa-divider text-wa-gray px-3 py-1 rounded-full capitalize">${v}</span>`;
                });
            } else {
                variantContainer.innerHTML = '<span class="text-xs text-wa-gray italic">Tidak ada info fitur khusus</span>';
            }

            // --- RENDER IMAGE SLIDER (PEEKING LOGIC) ---
            const slider = document.getElementById('detail-slider');
            slider.innerHTML = '';

            for (let i = 1; i <= 10; i++) {
                const num = String(i).padStart(2, '0');
                let imgUrl;
                if (i <= 8) imgUrl = `${IMAGEKIT_BASE}/${item.folder_id}/${num}.png`;
                else imgUrl = `${IMAGEKIT_BASE}/feature-service/${num}.png`;

                imgUrl += "?tr=w-800"; // Optimasi

                // TRICK PEEKING:
                // Container Slider Full Width 1:1.
                // Item didalamnya kita set width 85% (w-[85%]).
                // Sisanya (15%) akan menampilkan potongan gambar berikutnya.
                // aspect-[4/5] menjaga rasio gambar asli agar tidak gepeng, object-cover memotongnya agar rapi di dalam kotak.
                
                const slideItem = document.createElement('div');
                slideItem.className = "snap-center shrink-0 w-[85%] h-full flex items-center justify-center bg-wa-bg rounded-lg overflow-hidden relative";
                
                slideItem.innerHTML = `
                    <img src="${imgUrl}" class="w-full h-full object-cover" loading="${i===1?'eager':'lazy'}" onerror="this.src='https://placehold.co/400x500/333?text=Slide+Error'">
                `;
                slider.appendChild(slideItem);
            }

            // Reset Slider Position
            slider.scrollLeft = 0;

            // Simpan data item ini di window object untuk fungsi WA
            window.currentItem = item;

            showView('view-detail');
            navigationStack.push('view-detail');
        }

        function kirimPesanWA() {
            if(!window.currentItem) return;
            const item = window.currentItem;
            const text = `Halo Admin, saya tertarik dengan tema undangan *${item.title}* (Paket ${item.tier}) seharga Rp ${item.price_real.toLocaleString('id-ID')}. Info lebih lanjut?`;
            const url = `https://wa.me/6281234567890?text=${encodeURIComponent(text)}`; // GANTI NO WA DISINI
            window.open(url, '_blank');
        }

        window.onload = loadData;

    </script>
</body>
</html>
