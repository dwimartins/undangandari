<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Katalog Animasi & Aset Digital</title>
    
    <!-- TAILWIND & FIREBASE -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        wa: { bg: '#111b21', header: '#202c33', teal: '#00a884', light: '#e9edef', gray: '#8696a0', divider: '#222d36' }
                    },
                    fontFamily: { sans: ['Inter', 'sans-serif'] }
                }
            }
        }
    </script>
    <style>
        body { background-color: #111b21; color: #e9edef; -webkit-tap-highlight-color: transparent; }
        .hide-scroll::-webkit-scrollbar { display: none; }
        .hide-scroll { -ms-overflow-style: none; scrollbar-width: none; }
        .active-tab { background-color: #00a884; color: white; border-color: transparent; }
        .inactive-tab { background-color: transparent; color: #8696a0; border-color: #222d36; }
        
        /* Smooth Fade In */
        .fade-in { animation: fadeIn 0.3s ease-out forwards; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="antialiased min-h-screen bg-[#0b141a]">

    <!-- ==========================================
         VIEW 1: HOME CATALOG
         ========================================== -->
    <div id="view-home" class="block pb-20">
        <!-- Header -->
        <div class="fixed top-0 left-0 right-0 z-40 bg-wa-header/95 backdrop-blur-md shadow-md border-b border-wa-divider">
            <div class="max-w-md mx-auto px-4 h-16 flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <button onclick="window.location.href='../index.html'" class="p-2 -ml-2 rounded-full hover:bg-white/5 transition text-wa-light">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg>
                    </button>
                    <div>
                        <h1 class="font-bold text-base text-wa-light leading-tight">Katalog Aset</h1>
                        <p class="text-[10px] text-wa-teal font-medium tracking-wide">Animasi & Karakter Digital</p>
                    </div>
                </div>
            </div>
            <!-- Scrollable Tabs -->
            <div class="max-w-md mx-auto px-4 pb-0 overflow-x-auto hide-scroll">
                <div id="category-tabs" class="flex gap-2 pb-3 min-w-max">
                    <!-- Tabs injected by JS -->
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="pt-28 pb-10 max-w-md mx-auto min-h-screen">
            <div id="loading-spinner" class="flex flex-col items-center justify-center py-20 space-y-4">
                <div class="w-8 h-8 border-4 border-wa-teal border-t-transparent rounded-full animate-spin"></div>
                <p class="text-xs text-wa-gray animate-pulse">Memuat koleksi...</p>
            </div>
            
            <!-- List Container (Tier Sections) -->
            <div id="list-container" class="space-y-8 fade-in"></div>
        </div>
    </div>

    <!-- ==========================================
         VIEW 2: TIER DETAIL (2 COLUMNS GRID)
         ========================================== -->
    <div id="view-tier" class="hidden min-h-screen pb-10 bg-[#0b141a]">
        <!-- Tier Header -->
        <div class="fixed top-0 left-0 right-0 z-40 bg-wa-header/95 backdrop-blur-md shadow-md border-b border-wa-divider">
            <div class="max-w-md mx-auto px-4 h-16 flex items-center gap-3">
                <!-- REVISI: Tombol back memanggil history.back() -->
                <button onclick="history.back()" class="p-2 -ml-2 rounded-full hover:bg-white/5 transition text-wa-light shrink-0">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg>
                </button>
                <div class="truncate">
                    <h1 id="tier-header-title" class="font-bold text-base text-wa-light leading-tight truncate">Nama Tier</h1>
                    <p id="tier-header-count" class="text-[10px] text-wa-teal font-medium tracking-wide mt-0.5">0 Karakter Tersedia</p>
                </div>
            </div>
        </div>

        <!-- Grid Container -->
        <div class="pt-20 max-w-md mx-auto px-4">
            <div id="tier-grid" class="grid grid-cols-2 gap-3 fade-in">
                <!-- Images injected here -->
            </div>
        </div>
    </div>

    <!-- ==========================================
         VIEW 3: LIGHTBOX (FOCUS MODE)
         ========================================== -->
    <div id="view-lightbox" class="fixed inset-0 z-[100] bg-black hidden flex-col transition-opacity duration-300">
        <!-- Top bar -->
        <div class="h-16 flex items-center justify-between px-4 text-white bg-gradient-to-b from-black/80 to-transparent absolute top-0 left-0 right-0 z-50">
            <!-- REVISI: Tombol back memanggil history.back() -->
            <button onclick="history.back()" class="p-2 -ml-2 hover:bg-white/20 rounded-full transition bg-black/20 backdrop-blur">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg>
            </button>
            <div id="lightbox-counter" class="text-xs font-bold tracking-widest font-mono bg-black/40 px-3 py-1 rounded-full backdrop-blur">1 / 10</div>
            <div class="w-10"></div> <!-- Balancer -->
        </div>
        
        <!-- Image Area -->
        <div class="flex-1 relative flex items-center justify-center overflow-hidden w-full h-full">
            <!-- Spinner Background -->
            <div class="absolute inset-0 flex items-center justify-center -z-10">
                <div class="w-8 h-8 border-4 border-wa-teal border-t-transparent rounded-full animate-spin"></div>
            </div>

            <!-- Image -->
            <img id="lightbox-img" src="" class="max-w-full max-h-full object-contain relative z-10 select-none">
            
            <!-- Left Arrow -->
            <button id="btn-prev" onclick="changeLightboxImage(-1)" class="absolute left-4 top-1/2 -translate-y-1/2 p-3 bg-black/60 text-white rounded-full backdrop-blur-md border border-white/20 hover:bg-black/90 transition z-20 active:scale-95 shadow-lg">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
            </button>
            
            <!-- Right Arrow -->
            <button id="btn-next" onclick="changeLightboxImage(1)" class="absolute right-4 top-1/2 -translate-y-1/2 p-3 bg-black/60 text-white rounded-full backdrop-blur-md border border-white/20 hover:bg-black/90 transition z-20 active:scale-95 shadow-lg">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
            </button>
        </div>
    </div>

    <script>
        // --- 1. CONFIG ---
        const firebaseConfig = {
            apiKey: "AIzaSyDq6LjlUFRDm5CqGSqVLiJ9gItIyw71bAU",
            authDomain: "db-katalog.firebaseapp.com",
            projectId: "db-katalog",
            storageBucket: "db-katalog.firebasestorage.app",
            messagingSenderId: "597535674259",
            appId: "1:597535674259:web:0577885c617f623bb82266"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        let allData = [];
        let categories = new Set();
        let currentCategory = '';

        // Variabel untuk Lightbox & Tier View
        let currentTierItem = null;
        let currentImageIndex = 1;

        // --- HELPER: TEMPLATE WARNA BERGANTIAN (COLOR CYCLING) ---
        const TIER_COLORS = [
            { from: 'from-rose-500/10', bg: 'bg-rose-500/10' },       // 0: Rose / Merah
            { from: 'from-blue-500/10', bg: 'bg-blue-500/10' },       // 1: Biru / Navy
            { from: 'from-yellow-500/10', bg: 'bg-yellow-500/10' },   // 2: Emas / Kuning
            { from: 'from-emerald-500/10', bg: 'bg-emerald-500/10' }, // 3: Hijau Emerald
            { from: 'from-purple-500/10', bg: 'bg-purple-500/10' },   // 4: Ungu / Lilac
            { from: 'from-orange-500/10', bg: 'bg-orange-500/10' }    // 5: Orange / Coral
        ];

        // --- HISTORY MANAGEMENT (BACK BUTTON FIX) ---
        window.addEventListener('popstate', (event) => {
            const state = event.state;
            
            // Logic: Cek state history untuk menentukan view mana yang aktif
            if (state && state.view === 'lightbox') {
                // (Jarang terjadi, biasanya browser forward)
                document.getElementById('view-lightbox').classList.remove('hidden');
                document.getElementById('view-lightbox').classList.add('flex');
            } else if (state && state.view === 'tier') {
                // Back dari Lightbox ke Tier
                // ATAU Forward dari Home ke Tier
                
                // 1. Tutup Lightbox jika terbuka
                _internalHideLightbox();
                
                // 2. Pastikan Tier View terbuka & dirender
                // Jika data sudah ada, render ulang (aman)
                if (allData.length > 0) {
                    _internalRenderTier(state.id);
                }
            } else {
                // Back ke Home (State null atau home)
                _internalHideLightbox();
                _internalHideTier();
            }
        });

        // --- 2. LOAD DATA ---
        async function loadData() {
            try {
                // Set initial state agar tombol back dari home tidak error
                history.replaceState({ view: 'home' }, '', '');

                const snapshot = await db.collection('animasi_catalog').get();
                if (snapshot.empty) {
                    document.getElementById('list-container').innerHTML = '<p class="text-center text-wa-gray text-xs py-10">Belum ada data katalog.</p>';
                    document.getElementById('loading-spinner').style.display = 'none';
                    return;
                }

                allData = snapshot.docs.map(doc => doc.data());
                
                allData.forEach(item => categories.add(item.category));
                const sortedCategories = Array.from(categories).sort();
                
                renderTabs(sortedCategories);

                if(sortedCategories.length > 0) {
                    selectCategory(sortedCategories[0]);
                }

                document.getElementById('loading-spinner').style.display = 'none';

                // Cek Deep Link (Opsional: Jika user refresh di URL ber-hash)
                // if (window.location.hash.includes('tier-')) { ... }

            } catch (error) {
                console.error("Error loading data:", error);
                document.getElementById('loading-spinner').innerHTML = `<p class="text-red-400 text-xs">Gagal memuat data.<br>${error.message}</p>`;
            }
        }

        // --- 3. RENDER TABS ---
        function renderTabs(cats) {
            const container = document.getElementById('category-tabs');
            container.innerHTML = '';
            cats.forEach(cat => {
                const btn = document.createElement('button');
                btn.className = `px-4 py-2 rounded-full text-xs font-bold border transition whitespace-nowrap inactive-tab flex items-center gap-1.5`;
                
                let displayName = cat.split(/[-_]/).map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ');
                
                let icon = 'âœ¨'; 
                if (displayName.toLowerCase().includes('warna')) icon = 'ðŸŽ¨';
                else if (displayName.toLowerCase().includes('faceless') || displayName.toLowerCase().includes('islami')) icon = 'ðŸ§•';
                
                btn.innerHTML = `<span>${icon}</span> <span>${displayName}</span>`;
                btn.onclick = () => selectCategory(cat);
                btn.dataset.cat = cat;
                container.appendChild(btn);
            });
        }

        // --- 4. RENDER HOME (GROUP BY TIER) ---
        function selectCategory(catName) {
            currentCategory = catName;
            
            document.querySelectorAll('#category-tabs button').forEach(btn => {
                if(btn.dataset.cat === catName) {
                    btn.className = "px-4 py-2 rounded-full text-xs font-bold border transition whitespace-nowrap active-tab shadow-lg shadow-wa-teal/20 flex items-center gap-1.5";
                } else {
                    btn.className = "px-4 py-2 rounded-full text-xs font-bold border transition whitespace-nowrap inactive-tab hover:bg-wa-header flex items-center gap-1.5";
                }
            });

            const filtered = allData.filter(item => item.category === catName);
            filtered.sort((a,b) => a.title.localeCompare(b.title));
            
            const container = document.getElementById('list-container');
            container.innerHTML = '';

            if (filtered.length === 0) {
                container.innerHTML = `<div class="text-center text-wa-gray text-xs py-10">Belum ada koleksi di kategori ini.</div>`;
                return;
            }

            filtered.forEach((item, index) => {
                const count = item.total || 0;
                const cleanFolder = item.folder_link.replace(/\/$/, "");
                const glow = TIER_COLORS[index % TIER_COLORS.length]; 

                const section = document.createElement('div');
                section.className = "mb-4";

                const limit = Math.min(count, 3);
                let cardsHtml = '';

                if (limit === 0) {
                    cardsHtml = `<div class="col-span-3 bg-[#202c33] p-6 rounded-xl border border-wa-divider text-center text-xs text-wa-gray font-medium">Gambar sedang disiapkan...</div>`;
                } else {
                    for (let i = 1; i <= limit; i++) {
                        const thumbUrl = `${cleanFolder}/${i}.png?tr=w-200`;
                        const fallbackUrl = `${cleanFolder}/${i}.jpg?tr=w-200`;

                        cardsHtml += `
                            <div onclick="openTier('${item.id}')" class="group relative bg-[#202c33] rounded-xl overflow-hidden border border-wa-divider hover:border-wa-teal/50 transition-all duration-300 active:scale-[0.98] cursor-pointer shadow-sm">
                                <div class="aspect-[3/4] w-full relative flex items-end justify-center pt-4 bg-[#111b21]">
                                    <div class="absolute inset-0 bg-gradient-to-t ${glow.from} via-transparent to-transparent opacity-50"></div>
                                    <div class="absolute bottom-0 w-24 h-24 ${glow.bg} blur-2xl rounded-full"></div>
                                    <img src="${thumbUrl}" onerror="this.src='${fallbackUrl}'; this.onerror=null;" class="h-[95%] object-contain relative z-10 drop-shadow-xl transition-transform duration-500 group-hover:scale-105" loading="lazy">
                                    <div class="absolute inset-0 bg-black/0 group-hover:bg-black/10 transition-colors z-20 pointer-events-none"></div>
                                </div>
                            </div>
                        `;
                    }
                }

                section.innerHTML = `
                    <div class="px-4 flex justify-between items-center mb-3">
                        <div class="border-l-4 border-wa-teal pl-3">
                            <div class="flex items-center gap-2">
                                <span class="text-lg filter drop-shadow-sm">âœ¨</span>
                                <h2 class="text-wa-light font-bold text-base tracking-wide">${item.title}</h2>
                            </div>
                            <p class="text-[10px] text-wa-gray mt-0.5 font-medium tracking-wide uppercase">${count} Koleksi Tersedia</p>
                        </div>
                        <button onclick="openTier('${item.id}')" class="bg-[#2a373f] border border-wa-divider text-wa-teal text-[10px] font-bold px-3.5 py-1.5 rounded-full hover:bg-wa-teal hover:text-white hover:border-transparent transition active:scale-95 shadow-sm uppercase tracking-wider shrink-0">Lihat Semua</button>
                    </div>
                    <div class="px-4 grid grid-cols-3 gap-3">
                        ${cardsHtml}
                    </div>
                `;
                container.appendChild(section);
            });
        }

        // --- 5. TIER DETAIL LOGIC (GRID 2 COLUMN) ---
        
        // Fungsi Publik (Dipanggil saat klik) - Memanipulasi History
        function openTier(id) {
            // Push state ke history browser
            history.pushState({ view: 'tier', id: id }, '', `#tier-${id}`);
            // Panggil fungsi internal untuk render UI
            _internalRenderTier(id);
        }

        // Fungsi Internal (Render UI) - Dipanggil oleh openTier dan popstate
        function _internalRenderTier(id) {
            const item = allData.find(d => d.id === id);
            if (!item) return;

            currentTierItem = item;
            const total = item.total || 0;

            const catItems = allData.filter(d => d.category === item.category).sort((a,b) => a.title.localeCompare(b.title));
            const tierIndex = catItems.findIndex(d => d.id === item.id);
            const glow = TIER_COLORS[tierIndex % TIER_COLORS.length];

            document.getElementById('tier-header-title').innerText = item.title;
            document.getElementById('tier-header-count').innerText = `${total} Karakter Tersedia`;

            const grid = document.getElementById('tier-grid');
            grid.innerHTML = '';
            
            const cleanFolder = item.folder_link.replace(/\/$/, "");

            if (total === 0) {
                grid.innerHTML = `<div class="col-span-2 text-center text-wa-gray text-xs py-20">Belum ada gambar di galeri ini.</div>`;
            }

            for (let i = 1; i <= total; i++) {
                const thumbUrl = `${cleanFolder}/${i}.png?tr=w-300`;
                const fallbackUrl = `${cleanFolder}/${i}.jpg?tr=w-300`;

                const card = document.createElement('div');
                card.className = "bg-[#202c33] rounded-xl overflow-hidden border border-wa-divider cursor-pointer relative group active:scale-[0.98] transition-transform shadow-sm";
                card.onclick = () => openLightbox(i); // Membuka lightbox via fungsi public
                
                card.innerHTML = `
                    <div class="aspect-[3/4] w-full relative flex items-end justify-center pt-4 bg-[#111b21]">
                        <div class="absolute inset-0 flex items-center justify-center">
                            <div class="w-5 h-5 border-2 border-wa-teal border-t-transparent rounded-full animate-spin"></div>
                        </div>
                        <div class="absolute inset-0 bg-gradient-to-t ${glow.from} via-transparent to-transparent opacity-50 pointer-events-none"></div>
                        <div class="absolute bottom-0 w-24 h-24 ${glow.bg} blur-2xl rounded-full pointer-events-none"></div>
                        <img src="${thumbUrl}" onerror="this.src='${fallbackUrl}'; this.onerror=null;" class="h-[95%] w-full object-contain relative z-10 transition-transform duration-500 group-hover:scale-105 drop-shadow-xl" loading="lazy">
                        <div class="absolute top-2 left-2 bg-black/60 backdrop-blur-sm text-white text-[10px] font-bold px-2 py-0.5 rounded border border-white/10 z-20 shadow-sm pointer-events-none">
                            #${i}
                        </div>
                    </div>
                `;
                grid.appendChild(card);
            }

            // Switch View
            document.getElementById('view-home').classList.add('hidden');
            document.getElementById('view-home').classList.remove('block');
            
            document.getElementById('view-tier').classList.remove('hidden');
            document.getElementById('view-tier').classList.add('block');
            
            window.scrollTo(0, 0);
        }

        // Fungsi Internal untuk menutup Tier (Kembali ke Home)
        function _internalHideTier() {
            document.getElementById('view-tier').classList.add('hidden');
            document.getElementById('view-tier').classList.remove('block');
            
            document.getElementById('view-home').classList.remove('hidden');
            document.getElementById('view-home').classList.add('block');
        }

        // --- 6. LIGHTBOX LOGIC (FOCUS MODE) ---
        
        // Fungsi Publik
        function openLightbox(index) {
            history.pushState({ view: 'lightbox' }, '', '#focus');
            _internalRenderLightbox(index);
        }

        // Fungsi Internal Render
        function _internalRenderLightbox(index) {
            currentImageIndex = index;
            updateLightboxImage();
            document.getElementById('view-lightbox').classList.remove('hidden');
            document.getElementById('view-lightbox').classList.add('flex');
            document.body.style.overflow = 'hidden';
        }

        function updateLightboxImage() {
            if (!currentTierItem) return;
            
            const total = currentTierItem.total || 0;
            const cleanFolder = currentTierItem.folder_link.replace(/\/$/, "");
            
            document.getElementById('lightbox-counter').innerText = `${currentImageIndex} / ${total}`;
            
            const imgEl = document.getElementById('lightbox-img');
            const basePng = `${cleanFolder}/${currentImageIndex}.png`;
            const baseJpg = `${cleanFolder}/${currentImageIndex}.jpg`;
            const baseWebp = `${cleanFolder}/${currentImageIndex}.webp`;

            imgEl.src = basePng;
            imgEl.onerror = function() {
                if (this.src === basePng) this.src = baseJpg;
                else if (this.src === baseJpg) this.src = baseWebp;
            };

            const btnPrev = document.getElementById('btn-prev');
            const btnNext = document.getElementById('btn-next');

            if (currentImageIndex <= 1) {
                btnPrev.style.opacity = '0.3';
                btnPrev.style.pointerEvents = 'none';
            } else {
                btnPrev.style.opacity = '1';
                btnPrev.style.pointerEvents = 'auto';
            }

            if (currentImageIndex >= total) {
                btnNext.style.opacity = '0.3';
                btnNext.style.pointerEvents = 'none';
            } else {
                btnNext.style.opacity = '1';
                btnNext.style.pointerEvents = 'auto';
            }
        }

        function changeLightboxImage(step) {
            const total = currentTierItem.total || 0;
            currentImageIndex += step;
            if (currentImageIndex < 1) currentImageIndex = 1;
            if (currentImageIndex > total) currentImageIndex = total;
            updateLightboxImage();
        }

        // Fungsi Internal Tutup Lightbox
        function _internalHideLightbox() {
            document.getElementById('view-lightbox').classList.add('hidden');
            document.getElementById('view-lightbox').classList.remove('flex');
            document.getElementById('lightbox-img').src = ''; 
            document.body.style.overflow = 'auto';
        }

        // Start
        window.onload = loadData;
    </script>
</body>
</html>
